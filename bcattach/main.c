#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/ioctl.h>
#include <sys/time.h>
#include <sys/poll.h>
#include <termios.h>
#include <linux/hsuart.h>

#include <linux/tty.h>

char recv_buffer[9000];

#define ppoll compat_ppoll

#define HCI_UART_H4	0
#define HCI_UART_BCSP	1
#define HCI_UART_3WIRE	2
#define HCI_UART_H4DS	3
#define HCI_UART_LL	4
#define HCI_UART_IBS	5

#define N_HCI		15

#define HCIUARTSETPROTO		_IOW('U', 200, int)

static inline int compat_ppoll(struct pollfd *fds, nfds_t nfds,
		const struct timespec *timeout, const sigset_t *sigmask)
{
	if (timeout == NULL)
		return poll(fds, nfds, -1);
	else if (timeout->tv_sec == 0)
		return poll(fds, nfds, 500);
	else
		return poll(fds, nfds, timeout->tv_sec * 1000);
}

void write_fd(int fd, char* data, int length)
{
	int i;
	write(fd,data,length);
	printf("Wrote ");

	for(i=0; i < length; i++)
		printf("%2.2X ", data[i]);
	printf("\n");
}

int read_fd_int(int fd)
{
	int bytes,i;
	fd_set fdset;
	struct timeval seltmout;

	FD_ZERO(&fdset);
	FD_SET(fd, &fdset);
	seltmout.tv_sec = 0;
	seltmout.tv_usec = 1000000;

	if (0 == select(fd+1, &fdset, NULL, NULL, &seltmout)) {
		printf("Select timed out!\n");
		return -1;
	}

	bytes = read(fd,recv_buffer,9000);
	
	printf("Read %d bytes: ", bytes);
	for(i=0; i < bytes; i++)
		printf("%2.2X ", recv_buffer[i]);

	printf("\n");
	return 0;
}

void read_fd(int fd)
{
	if(read_fd_int(fd)==-1)
		exit(-1);
}

void read_fd_nokill(int fd)
{
	read_fd_int(fd);
}

int main(int argc, char** argv)
{
	struct hsuart_mode uart_mode;
	int irq_fd, power_fd, reset_fd, uart_fd, rts_fd, mux_fd, i, err;
	struct pollfd p;
	sigset_t sigs;
	struct termios ti;

#if 0
	power_fd = open("/sys/devices/platform/bt_power.0/bluetooth_power", O_WRONLY);
	if(power_fd <=0)
	{
		printf("Could not open power\n");
		exit(-1);
	}
#endif
	reset_fd = open("/sys/user_hw/pins/bt/reset/level", O_WRONLY);
	if(reset_fd <=0)
	{
		printf("Could not open reset\n");
		exit(-1);
	}

	irq_fd = open("/sys/user_hw/pins/bt/host_wake/level", O_WRONLY);
	if(reset_fd <=0)
	{
		printf("Could not open host_wake\n");
		exit(-1);
	}
#if 0
	rts_fd = open("/sys/board_properties/rts_deassert", O_WRONLY);
	if(reset_fd <=0)
		exit(-1);

	mux_fd = open("/sys/board_properties/bt_pinmux", O_WRONLY);
	if(reset_fd <=0)
		exit(-1);

	//Set the mux
	lseek(mux_fd, 0, SEEK_SET);
	write(mux_fd, "1", 1);
	usleep(50000);

	//Assert the RTS
	lseek(rts_fd, 0, SEEK_SET);
	write(rts_fd, "1", 1);
	usleep(50000);

#endif

	uart_fd = open("/dev/ttyHS0", O_RDWR|O_NOCTTY|O_NONBLOCK);
	if(uart_fd <=0)
	{
		printf("Could not open uart\n");
		exit(-1);
	}
#if 0
	//Make sure power is off
	lseek(power_fd, 0, SEEK_SET);
	write(power_fd, "0", 1);
	usleep(100000);

	//Turn power back on
	lseek(power_fd, 0, SEEK_SET);
	write(power_fd, "1", 1);
	usleep(100000);
#endif
	//Set the wake
	lseek(irq_fd, 0, SEEK_SET);
	write(irq_fd, "1", 1);

	//Set the reset
	lseek(reset_fd, 0, SEEK_SET);
	write(reset_fd, "0", 1);
	usleep(100000);

	//Release the reset
	lseek(reset_fd, 0, SEEK_SET);
	write(reset_fd, "1", 1);
	usleep(1000000);


	//Setup the port
#if 1
	ioctl(uart_fd,HSUART_IOCTL_CLEAR_FIFO,0xF);
	ioctl(uart_fd,HSUART_IOCTL_GET_UARTMODE,&uart_mode);
	uart_mode.speed = 0x1C200; //115200
	uart_mode.flags = 0x9;
	ioctl(uart_fd, HSUART_IOCTL_SET_UARTMODE,&uart_mode);
	ioctl(uart_fd,HSUART_IOCTL_SET_RXLAT,0x80);
#else
	tcflush(uart_fd, TCIOFLUSH);
	if (tcgetattr(uart_fd, &ti) < 0) {
		perror("Can't get port settings");
		return -1;
	}
	//ti.c_cflag = 0;

	printf("Flags 0x%8.8X\n", ti.c_cflag);
	ti.c_cflag = 0;
	cfmakeraw(&ti);
	ti.c_cflag |= CS8 | CREAD | PARENB | CLOCAL; 
//	ti.c_cflag |= CRTSCTS; 
//	ti.c_cflag &= ~CLOCAL;
	cfsetospeed(&ti, B115200);
	cfsetispeed(&ti, B115200);
	tcsetattr(uart_fd, TCSANOW, &ti);

	//Deassert the RTS
	lseek(rts_fd, 0, SEEK_SET);
	write(rts_fd, "1", 1);

	lseek(rts_fd, 0, SEEK_SET);
	write(rts_fd, "0", 1);
#endif

#if 0
//	write_fd(uart_fd,"\xc2\x21\x42\x00\x7e\xda\xdc\xea\xed\xa9\x7a\xc0",1);
	read_fd(uart_fd);
	read_fd(uart_fd);


#endif
	
	for(i=0; i < 100; i++)
	{
		write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xda\xdc\xed\xed\xa9\x7a\xc0",12);
		read_fd(uart_fd);

		write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xac\xaf\xef\xee\xbb\x84\xc0",12);
		read_fd(uart_fd);
		if(strncmp(recv_buffer,"\xc0\x40\x41\x00\x7e\xac\xaf\xef\xee\xbb\x84\xc0",12)==0) break;
		read_fd(uart_fd);
		if(strncmp(recv_buffer,"\xc0\x40\x41\x00\x7e\xac\xaf\xef\xee\xbb\x84\xc0",12)==0) break;
		read_fd(uart_fd);
		if(strncmp(recv_buffer,"\xc0\x40\x41\x00\x7e\xac\xaf\xef\xee\xbb\x84\xc0",12)==0) break;
	}
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xda\xdc\xed\xed\xa9\x7a\xc0",12);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xad\xef\xac\xed\xa1\xa6\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xde\xad\xd0\xd0\x83\x58\xc0",12);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\x48\x00\x00\xb7\x5e\x8c\xc0",8);
	usleep(50000);
	write_fd(uart_fd,"\xc0\xc8\x22\x01\x14\x00\x00\x09\x00\x00\x00\x19\x28\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdb\xdd\x70\xc0",27);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\x50\x00\x00\xaf\x53\xd1\xc0",8);
	usleep(60000);
	write_fd(uart_fd,"\xc0\xd1\x22\x01\x0b\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xfe\x01\x01\x00\x08\x00\x90\x65\x2e\x47\xc0",26);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\x58\x00\x00\xa7\x5a\x47\xc0",8);
	usleep(20000);
	write_fd(uart_fd,"\xc0\xda\x22\x01\x02\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xbe\x01\x01\x00\x08\x00\xfc\x3a\x30\x9a\xc0",26);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\xe3\x22\x01\xf9\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xab\x01\x01\x00\x08\x00\x01\x00\x0a\x13\xc0",26);
	read_fd(uart_fd);

	write_fd(uart_fd,"\xc0\xec\x22\x01\xf0\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xb0\x01\x01\x00\x08\x00\x01\x00\x38\x9c\xc0",26);
	read_fd(uart_fd);
//2190
	write_fd(uart_fd,"\xc0\xf5\x22\x01\xe7\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xb9\x01\x01\x00\x08\x00\x08\x00\x1a\x0b\xc0",26);
	read_fd(uart_fd);
//2247
	write_fd(uart_fd,"\xc0\xfe\x22\x01\xde\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xf6\x01\x01\x00\x08\x00\x19\x00\xe2\x2d\xc0",26);
	read_fd(uart_fd);
//2304
	write_fd(uart_fd,"\xc0\xc7\x22\x01\x15\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x11\x00\x01\x00\x08\x00\x54\x01\xf8\xc3\xc0",26);
	read_fd(uart_fd);
//2361
	write_fd(uart_fd,"\xc0\xc8\x22\x01\x14\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x13\x00\x01\x00\x08\x00\x0b\x00\x49\x7c\xc0",26);
	read_fd(uart_fd);
//2418
	write_fd(uart_fd,"\xc0\xd1\x22\x01\x0b\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x4d\x02\x01\x00\x08\x00\x00\x00\x6a\xd3\xc0",26);
	read_fd(uart_fd);
//2475
	write_fd(uart_fd,"\xc0\xda\x22\x01\x02\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x0e\x00\x01\x00\x08\x00\x01\x00\x58\x4d\xc0",26);
	read_fd(uart_fd);
//2532
	write_fd(uart_fd,"\xc0\xe3\x22\x01\xf9\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xf9\x01\x01\x00\x08\x00\x01\x00\x6d\xbf\xc0",26);
	read_fd(uart_fd);
//2589
	write_fd(uart_fd,"\xc0\xec\x22\x01\xf0\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x5d\x02\x01\x00\x08\x00\x01\x00\x32\xcc\xc0",26);
	read_fd(uart_fd);
//2646
	write_fd(uart_fd,"\xc0\xf5\x82\x01\x87\x02\x00\x0c\x00\x00\x00\x03\x70\x00\x00\x01\x00\x04\x00\x08\x00\x86\x00\xad\x13\xfe\x00\x1d\x00\xc8\x07\xc0",32);
	read_fd(uart_fd);
//2703
	write_fd(uart_fd,"\xc0\xfe\x22\x01\xde\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xf6\x00\x01\x00\x08\x00\x01\x00\xc3\x0e\xc0",26);
	read_fd(uart_fd);
//2760
	write_fd(uart_fd,"\xc0\xc7\x02\x05\x31\x02\x00\x28\x00\x00\x00\x03\x70\x00\x00\x03\x02\x20\x00\x08\x00\x02\x00\x36\x00\x04\x00\x82\x00\x06\x00\x43\x00\x08\x00\x4b\x00\x0a\x00\x2c\x00\x10\x00\x0f\x00\x14\x00\x29\x00\x20\x00\x26\x00\x24\x00\x0d\x00\x28\x00\x0a\x00\x34\x00\x03\x00\x46\x00\x0c\x00\x64\x00\x0a\x00\x74\x00\x0a\x00\x82\x00\x04\x00\x00\x00\x00\x00\x98\x52\xc0",88);
	read_fd(uart_fd);
//2817
	write_fd(uart_fd,"\xc0\xc8\x22\x01\x14\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x94\x03\x01\x00\x08\x00\xec\xff\x9f\x56\xc0",26);
	read_fd(uart_fd);
//2877
	write_fd(uart_fd,"\xc0\xd1\x82\x02\xaa\x02\x00\x14\x00\x00\x00\x03\x70\x00\x00\xaa\x03\x0c\x00\x08\x00\xd8\xff\x03\x00\xeb\xff\x01\x00\xec\xff\x05\x00\xf6\xff\x05\x00\x14\x00\x00\x00\x28\x00\xfe\xff\x82\x5b\xc0",48);
	read_fd(uart_fd);
//2934
	write_fd(uart_fd,"\xc0\xda\x82\x02\xa1\x02\x00\x14\x00\x00\x00\x03\x70\x00\x00\xab\x03\x0c\x00\x08\x00\xd8\xff\x03\x00\xeb\xff\x01\x00\xec\xff\x05\x00\xf6\xff\x05\x00\x14\x00\x00\x00\x28\x00\xfe\xff\x41\xb4\xc0",48);
	read_fd(uart_fd);
//2991
	write_fd(uart_fd,"\xc0\xe3\x22\x01\xf9\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xd4\x03\x01\x00\x08\x00\x07\x00\x0f\x49\xc0",26);
	read_fd(uart_fd);
//3048
	write_fd(uart_fd,"\xc0\xec\x82\x03\x8e\x02\x00\x1c\x00\x00\x00\x03\x70\x00\x00\x2c\x21\x14\x00\x08\x00\x01\x00\x38\xbb\x14\x3d\x35\xe3\xe8\x03\x14\x00\xe0\x06\x00\x01\x84\x1d\xfc\x03\x00\x01\x14\x1c\x25\xfa\x18\x00\x2b\xff\x0e\xff\x00\xbb\x18\x3b\xe2\x00\xb9\xfd\x49\xfc\xc0",64);
	read_fd(uart_fd);
//3105
	write_fd(uart_fd,"\xc0\xf5\x02\x03\x05\x02\x00\x18\x00\x00\x00\x03\x70\x00\x00\x2d\x21\x10\x00\x08\x00\x01\x00\x82\xe9\x00\xe0\x15\xa9\x00\xe9\x25\x38\x00\xe0\x15\xab\x27\x01\x18\x00\x2b\xff\x0e\xff\x00\xea\x18\x85\xe2\x00\xd8\x84\x38\xc9\xc0",56);
	read_fd(uart_fd);
//3162
	write_fd(uart_fd,"\xc0\xfe\x42\x05\xba\x02\x00\x2a\x00\x00\x00\x03\x70\x00\x00\x2e\x21\x22\x00\x08\x00\x01\x00\x76\xa2\x00\xff\x25\x7e\x00\xff\x15\xc8\xc4\x8f\xb4\x40\x00\xff\x25\xc8\x15\x89\x00\x90\xc4\xff\x00\x30\xb4\x00\x25\x89\x00\xe4\x15\x6c\x00\x90\xc4\xff\x00\x30\xb4\x00\x00\xe4\x25\x6c\x00\xe4\x15\x6d\x00\x90\xc4\xff\x00\x30\xb4\x00\x00\xe4\x25\x6d\xe3\xff\xd6\xfe\x4c\xf6\xc0",92);
	read_fd(uart_fd);
//3219
	write_fd(uart_fd,"\xc0\xc7\xc2\x06\x70\x02\x00\x36\x00\x00\x00\x03\x70\x00\x00\x2f\x21\x2e\x00\x08\x00\x01\x00\x2d\xa3\x00\xff\x25\x7e\x16\x02\x00\xe4\x18\x6c\x00\xff\x11\xc8\xdb\xdc\x8f\x84\x1e\xf4\x15\x84\x3e\xf4\x13\xb0\x40\x00\xff\x21\xc8\x00\x90\x14\xff\x11\x89\xc1\xe1\x00\x30\xb0\x00\x21\x89\x12\x00\xc1\xe1\x00\x30\xb0\x00\xc6\x01\x00\x30\xb4\x00\xe0\x0b\x00\x70\x14\x00\x00\xff\x21\xc8\x11\x89\xb1\xe1\x21\x89\x12\x00\xb1\xe1\xb6\x01\x22\x00\x26\x01\xe3\xff\xbb\xa6\x8b\x3e\xc0",117);
	read_fd(uart_fd);
//3276
	write_fd(uart_fd,"\xc0\xc8\xe2\x02\x53\x02\x00\x17\x00\x00\x00\x03\x70\x00\x00\x30\x21\x0f\x00\x08\x00\x01\x00\x97\xf8\x14\x00\x1b\x00\x26\x02\x1b\x00\x12\x07\x16\x08\x18\x00\x2b\xff\x0e\xff\x00\xf9\x18\x9a\xe2\x00\xa4\x76\xbf\x1f\xc0",54);
	read_fd(uart_fd);
//3333
	write_fd(uart_fd,"\xc0\xd1\xa2\x03\x89\x02\x00\x1d\x00\x00\x00\x03\x70\x00\x00\x31\x21\x15\x00\x08\x00\x01\x00\x97\xe8\x00\xe0\x15\xb5\x84\x02\xf4\x09\x84\x03\xf4\x07\x18\x00\x2b\xff\x0e\xff\x00\xe9\x18\x9b\xe2\x00\x18\x00\x2b\xff\x0e\xff\x00\xe9\x18\xd6\xe2\x00\xed\x3b\x8c\x53\xc0",66);
	read_fd(uart_fd);
//3390
	write_fd(uart_fd,"\xc0\xda\x82\x04\x9f\x02\x00\x24\x00\x00\x00\x03\x70\x00\x00\x32\x21\x1c\x00\x08\x00\x01\x00\xaa\xe9\x17\x01\x00\xe9\x85\x38\xf0\x0d\x00\xe0\x15\xd2\xf4\x0a\x18\x00\x2b\xff\x0e\xff\x00\x3b\x18\x91\x9e\x00\x14\x00\x00\xe0\x25\xd2\x00\xe0\x15\xbe\x34\x01\x18\x00\x2b\xff\x0e\xff\x00\xea\x18\xad\xe2\x00\x0d\x89\xd8\x6c\xc0",80);
	read_fd(uart_fd);
//3447
	write_fd(uart_fd,"\xc0\xe3\xe2\x05\x35\x02\x00\x2f\x00\x00\x00\x03\x70\x00\x00\x33\x21\x27\x00\x08\x00\x01\x00\x04\xc9\x18\x00\x2b\x13\x0e\x13\x00\x3d\x9e\x21\x00\xe9\x18\x35\x26\x00\x00\xe4\x15\x6d\x26\xff\x14\x60\x26\x01\x15\xe4\x0e\x13\x00\xdd\x9e\xdb\xdc\x9c\x01\x00\xe2\x19\x28\x00\xff\x00\x70\x9e\x00\x15\x89\x00\xe4\x25\x6d\x00\xff\x15\xc5\x00\xe5\x25\xe7\x15\xe4\x0e\x13\x00\xc7\x18\xc5\x9e\x00\x0f\xd8\x0b\x1f\xb0\x41\xc0",103);
	read_fd(uart_fd);
//3504
	write_fd(uart_fd,"\xc0\xec\x02\x06\x0b\x02\x00\x30\x00\x00\x00\x03\x70\x00\x00\x34\x21\x28\x00\x08\x00\x01\x00\xcb\xc9\x00\x26\x88\xce\xf0\x06\x11\xb5\x73\x04\x00\x02\x80\xf3\xe6\x05\x0b\xe3\x00\xdf\x15\xf3\x00\x80\x84\x01\xf4\x17\x00\xe9\x18\x35\x12\x00\x00\x80\x80\x01\xf0\x03\x26\x00\xe0\x0f\x56\x00\x27\x16\x92\x01\x11\xe1\xa4\x07\x00\xe8\x31\x80\x23\x15\x9c\x01\x00\xe2\x19\x26\x00\xff\x00\x70\xe2\x00\x0f\xe3\xff\xbb\x28\x69\xc0",104);
	read_fd(uart_fd);
//3561
	write_fd(uart_fd,"\xc0\xf5\x02\x04\x04\x02\x00\x20\x00\x00\x00\x03\x70\x00\x00\x35\x21\x18\x00\x08\x00\x01\x00\xbf\xc8\x84\xfd\xf8\x0e\x87\x03\xf8\x06\x27\x03\x15\x89\x00\x10\xc4\xff\x27\x02\x18\x00\x2b\xff\x0e\xff\x00\xc9\x18\xc7\xe2\x00\x18\x00\x2b\xff\x0e\xff\x00\xc9\x18\xe5\xe2\x00\xac\x58\x6b\x0b\xc0",72);
	read_fd(uart_fd);
//3618
	write_fd(uart_fd,"\xc0\xfe\xe2\x04\x1b\x02\x00\x27\x00\x00\x00\x03\x70\x00\x00\x36\x21\x1f\x00\x08\x00\x02\x00\x52\x25\x21\xf9\x84\x00\xf4\x13\x19\xe1\x16\x03\x12\x00\x80\x32\xf4\x05\x80\x16\xf0\x0d\x00\x04\x90\xe8\x27\x00\x16\x01\x12\x02\x18\x00\x2b\xff\x0e\xff\x00\xe4\x18\x8b\x9e\x00\x0f\xf7\x18\x01\x2b\xff\x0e\xff\x00\x25\x18\x56\xe2\x00\xd3\xce\x69\xb5\xc0",86);
	read_fd(uart_fd);
//3675
	write_fd(uart_fd,"\xc0\xc7\xa2\x04\x92\x02\x00\x25\x00\x00\x00\x03\x70\x00\x00\x37\x21\x1d\x00\x08\x00\x01\x00\x6e\xe0\x00\xe1\x88\xa9\xf4\x0d\x00\xe8\x19\x9f\x1a\x07\x16\x04\x09\x00\x00\x04\x90\xe8\x23\x00\x27\x01\x00\xe8\x19\x9f\x1a\x02\x13\x00\x17\x01\x36\x0a\x42\x09\x22\x09\x26\x0a\x55\xf9\x61\xf8\x80\x00\xec\xf7\x0f\xfc\xc1\x82\xe6\xb5\xc0",82);
	read_fd(uart_fd);
//3732
	write_fd(uart_fd,"\xc0\xc8\xa2\x02\x93\x02\x00\x15\x00\x00\x00\x03\x70\x00\x00\x38\x21\x0d\x00\x08\x00\x01\x00\x03\xe3\x16\x04\x09\x00\x00\x04\x90\xe8\x18\x00\x2b\xff\x0e\xff\x00\xe3\x18\x14\xe2\x00\x29\x49\x81\x1e\xc0",50);
	read_fd(uart_fd);
//3797
	write_fd(uart_fd,"\xc0\xd1\x62\x06\xc6\x02\x00\x33\x00\x00\x00\x03\x70\x00\x00\x39\x21\x2b\x00\x08\x00\x01\x00\x38\xcb\x0b\xf9\x00\xe0\x15\x80\x09\x00\x00\x04\x90\xe8\x18\x01\x2b\x00\x18\x1f\x2b\x01\x18\x00\x2b\xff\x0e\xff\x00\x07\x18\xf8\x9e\x00\xf0\x17\x10\x00\x00\xcb\x14\x55\x23\x00\x27\x01\x18\x00\x2b\x02\x14\x01\x27\x03\x18\x1f\x2b\x04\x00\xe0\x15\x80\x09\x00\x00\x04\x90\xe8\x18\x00\x2b\xff\x0e\xff\x00\x07\x18\x05\x9e\x00\x0f\xf9\xc6\x2e\x8f\xc7\xc0",110);
	read_fd(uart_fd);
//3854
	write_fd(uart_fd,"\xc0\xda\x82\x01\xa2\x02\x00\x0c\x00\x00\x00\x03\x70\x00\x00\x3a\x21\x04\x00\x08\x00\x03\x00\x37\xba\xe2\x00\x0d\x58\xb1\xce\xc0",32);
	read_fd(uart_fd);
//3899
	write_fd(uart_fd,"\xc0\x60\x00\x00\x9f\xdd\x6f\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xe3\x02\x03\x17\x02\x00\x18\x00\x00\x00\x03\x70\x00\x00\xe1\x21\x10\x00\x08\x00\xd8\xff\x02\x00\xeb\xff\x01\x00\xec\xff\xff\xff\xf6\xff\x00\x00\x32\x00\x00\x00\x3c\x00\x01\x00\x50\x00\x02\x00\x64\x00\x03\x00\xd9\x12\xc0",56);
	read_fd(uart_fd);
//3983
	write_fd(uart_fd,"\xc0\xec\x42\x03\xce\x02\x00\x1a\x00\x00\x00\x03\x70\x00\x00\x15\x22\x12\x00\x08\x00\x0b\xfe\x17\x02\x1b\x03\x00\x2d\x84\xff\xf0\x0b\x16\x00\x84\x0e\xf0\x08\x17\x06\x00\x01\x84\x0f\xf0\x04\x00\x01\x14\xdc\x27\x06\x0f\xfe\x5e\xc3\xef\x31\xc0",60);
	read_fd(uart_fd);
//4040
	write_fd(uart_fd,"\xc0\xf5\x82\x04\x84\x02\x00\x24\x00\x00\x00\x03\x70\x00\x00\x16\x22\x1c\x00\x08\x00\x0b\xfe\x1b\x02\x17\x03\x84\x04\xf0\x16\x9b\x04\xf0\x14\x16\x01\x84\x01\xf0\x11\x1a\x02\x16\x00\x84\x07\xf0\x0d\x12\x02\x15\xe0\xc4\xfe\x00\x08\x84\x0e\xf0\x07\x15\xe0\x00\x01\xc4\xff\x00\x13\xb4\x00\x26\x02\x0f\xfe\xe4\xba\xd7\xf9\xc0",80);
	read_fd(uart_fd);
//4097
	write_fd(uart_fd,"\xc0\xfe\xe2\x08\x17\x02\x00\x47\x00\x00\x00\x03\x70\x00\x00\x27\x22\x3f\x00\x08\x00\x9c\x29\x13\x00\x9c\x27\x27\x04\x00\x0f\x14\x33\x9c\x28\x27\x05\x14\x03\x9c\x24\x27\x06\x00\x20\x14\x69\x9c\x21\x87\x05\x24\x02\x27\x05\x14\x05\x9c\x1b\x87\x04\x24\x02\x17\x04\x77\x06\x00\x02\x84\x90\x28\x08\x17\x05\x77\x06\x87\x02\x24\x04\x27\x02\x13\x00\x23\x03\x13\x00\x33\x0a\x83\x01\x2c\xde\x13\x03\x00\xff\x21\xc5\x0f\xf6\x23\x00\x00\xff\x21\xc5\x14\x01\xa0\x0b\x0b\xfc\x25\x03\x14\x00\x13\x0f\x27\x01\x23\x00\x0e\x0b\x00\xc7\x18\x5f\x9e\x00\x37\x01\x13\x00\x30\xff\xf0\xf7\x97\x0f\x0f\xfc\x0e\xc7\x35\x8e\xc0",150);
	read_fd(uart_fd);
//4193
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(2000);
	write_fd(uart_fd,"\xc0\xc7\xc2\x08\x6e\x02\x00\x46\x00\x00\x00\x03\x70\x00\x00\x28\x22\x3e\x00\x08\x00\x13\x16\x30\x10\x80\x20\x2c\x36\x10\x00\x23\x1a\x15\xe4\x34\x02\x0e\x1a\x00\xc6\x18\xf5\x9e\x00\x13\x15\x30\xe2\x00\xe9\x15\x37\x34\x1e\x27\x00\x35\xe0\x18\x01\x2b\x01\x9c\x01\x00\xe2\x19\x27\x00\xff\x00\x70\x9e\x00\x14\xf8\x83\x15\x2c\x02\x14\x08\x9b\x16\xe8\x02\x74\x00\x00\xe9\x35\x36\x84\x7f\x28\x03\x00\x01\x14\x80\x84\x3f\x20\x02\x14\x40\x00\xe9\x25\x36\x93\x16\x11\xe1\xa4\x07\x00\xe8\x31\x80\x23\x15\x15\xe4\x34\x02\x0e\x1a\x00\xc7\x18\xc5\x9e\x00\x17\x15\x00\xe5\x25\xe7\x0f\xe3\x40\x6a\xf9\x0c\xc0",148);
	read_fd(uart_fd);
//4262
	write_fd(uart_fd,"\xc0\xc8\xa2\x04\x91\x02\x00\x25\x00\x00\x00\x03\x70\x00\x00\x29\x22\x1d\x00\x08\x00\x0b\xf6\x27\x01\x00\x80\x14\xff\x27\x02\x14\x00\x27\x03\x27\x07\x00\x50\x14\x07\x00\xff\x25\x7b\x00\xff\x15\xcf\x00\xdb\xdc\xc4\x0f\x00\xe4\xb5\x76\x00\xff\x25\xcf\x00\xe9\x15\x34\x25\x89\x00\xe2\x19\x25\x00\xff\x00\x70\xe2\x00\x92\xdb\xdd\x87\x77\xc0",84);
	read_fd(uart_fd);
//4319
	write_fd(uart_fd,"\xc0\xd1\x42\x08\xe4\x02\x00\x42\x00\x00\x00\x03\x70\x00\x00\x2a\x22\x3a\x00\x08\x00\x0b\xf1\x00\x01\x10\x6d\x00\x02\x14\x35\x9c\x2a\x00\xe8\x21\x80\x23\x0a\x30\xe2\x9c\x24\x27\x0b\x13\x0a\x9c\x21\x13\x0a\x87\x0b\x20\x06\x30\x02\x23\x0a\x00\x02\x80\x57\x2c\xf7\x00\xe8\x51\x80\x00\xe9\x21\x37\x15\xe4\x10\x00\x23\x0c\x0e\x22\x00\xc9\x18\x86\x9e\x00\x14\xfd\x25\xf8\x9c\x01\x00\xe2\x19\x29\x00\xe5\x11\xdb\xdd\x00\x10\xdb\xdc\x00\x00\xff\x00\x70\xf6\x00\x0f\xf1\x15\xe0\x0b\xf6\x18\x02\x2b\x0a\x18\x08\x2b\x0b\x00\xe2\x19\x27\x00\xff\x00\x70\xe2\x01\x36\x9c\x85\x5c\xc0",142);
	read_fd(uart_fd);
//4376
	write_fd(uart_fd,"\xc0\xda\x42\x04\xdf\x02\x00\x22\x00\x00\x00\x03\x70\x00\x00\x2b\x22\x1a\x00\x08\x00\x19\xe4\x15\xe4\x34\x0a\x25\xfa\x16\x01\x12\x00\xe8\x04\x81\xf8\xfc\x06\xe0\x0c\x99\xf8\xec\x03\x87\x0c\x2c\x08\x27\x0c\x15\x89\x00\xf0\xc4\x00\xb7\x0c\x25\x89\x21\xf8\x38\x02\x89\xfa\xfc\xed\x0f\xf1\x8f\x33\xcc\x61\xc0",76);
	read_fd(uart_fd);
//4433
	write_fd(uart_fd,"\xc0\xe3\x42\x01\xd9\x02\x00\x0a\x00\x00\x00\x03\x70\x00\x00\xb3\x01\x02\x00\x08\x00\xa0\x08\x16\x00\x8d\xa8\xc0",28);
	read_fd(uart_fd);
//4474
	write_fd(uart_fd,"\xc0\x68\x00\x00\x97\xd4\xf9\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xec\x22\x01\xf0\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xb6\x01\x01\x00\x08\x00\x60\x00\x04\x1a\xc0",26);
	read_fd(uart_fd);
//4538
	write_fd(uart_fd,"\xc0\x70\x00\x00\x8f\xd9\xa4\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xf5\x22\x01\xe7\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xbf\x01\x01\x00\x08\x00\x2e\x08\x42\x6c\xc0",26);
	read_fd(uart_fd);
//4603
	write_fd(uart_fd,"\xc0\x78\x00\x00\x87\xd0\x32\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xfe\x42\x01\xbe\x02\x00\x0a\x00\x00\x00\x03\x70\x00\x00\xf7\x01\x02\x00\x08\x00\x00\x00\x00\x00\xa1\xcb\xc0",28);
	read_fd(uart_fd);
//4667
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xc7\x42\x01\xf5\x02\x00\x0a\x00\x00\x00\x03\x70\x00\x00\xf8\x01\x02\x00\x08\x00\x00\x00\x00\x00\x94\x58\xc0",28);
	read_fd(uart_fd);
//4733
	write_fd(uart_fd,"\xc0\x48\x00\x00\xb7\x5e\x8c\xc0",8);
	usleep(5000);	
	write_fd(uart_fd,"\xc0\xc8\x42\x01\xf4\x02\x00\x0a\x00\x00\x00\x03\x70\x00\x00\xba\x01\x02\x00\x08\x00\x02\x10\x77\x01\x98\x6e\xc0",28);
	read_fd(uart_fd);
//4797	
	write_fd(uart_fd,"\xc0\x50\x00\x00\xaf\x53\xd1\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xd1\x82\x01\xab\x02\x00\x0c\x00\x00\x00\x03\x70\x00\x00\xc7\x01\x04\x00\x08\x00\x01\x00\xe8\x03\x0a\x00\x64\x00\xab\x76\xc0",32);
	read_fd(uart_fd);
//4866
	write_fd(uart_fd,"\xc0\x58\x00\x00\xa7\x5a\x47\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xda\x22\x01\x02\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\xca\x01\x01\x00\x08\x00\x31\x00\x05\xc4\xc0",26);
	read_fd(uart_fd);
//4929
	write_fd(uart_fd,"\xc0\x60\x00\x00\x9f\xdd\x6f\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xe3\x22\x01\xf9\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x21\x00\x01\x00\x08\x00\x04\x00\x30\x23\xc0",26);
	read_fd(uart_fd);
//4990
	write_fd(uart_fd,"\xc0\x68\x00\x00\x97\xd4\xf9\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xec\x22\x01\xf0\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x17\x00\x01\x00\x08\x00\x04\x00\xb6\x9c\xc0",26);
	read_fd(uart_fd);
//5060
	write_fd(uart_fd,"\xc0\x70\x00\x00\x8f\xd9\xa4\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xf5\xc2\x04\x44\x02\x00\x26\x00\x00\x00\x03\x70\x00\x00\x31\x00\x1e\x00\x08\x00\x00\x22\x50\x00\x00\x26\x50\x00\x00\xf0\x00\x28\x50\x00\x00\x2d\x50\x00\x00\xf4\x00\x25\x40\x00\x00\x2a\x40\x00\x00\xf8\x00\x22\x20\x00\x00\x27\x20\x00\x00\xfc\x00\x26\x10\x00\x00\x2c\x10\x00\x00\x00\x00\x2c\x00\x00\x00\x3a\x00\x00\x00\x04\x10\x5d\xc0",84);
	read_fd(uart_fd);
//5143
	write_fd(uart_fd,"\xc0\xfe\x22\x01\xde\x02\x00\x09\x00\x00\x00\x03\x70\x00\x00\x1d\x00\x01\x00\x08\x00\x10\x24\xc4\x24\xc0",26);
	read_fd(uart_fd);
//5180
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(5000);
	write_fd(uart_fd,"\xc0\xc7\x22\x01\x15\x02\x00\x09\x00\x00\x00\x02\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf5\xd2\xc0",26);
	read_fd(uart_fd); 
//Device should have gone away, baud rate change
	read_fd_nokill(uart_fd);
	read_fd_nokill(uart_fd);

	close(uart_fd);


	return 0;

	uart_fd = open("/dev/ttyHS0", O_RDWR|O_NOCTTY|O_NONBLOCK);
	if(uart_fd <=0)
		exit(-1);

	//Setup the port for ne fast speed
	ioctl(uart_fd,HSUART_IOCTL_CLEAR_FIFO,0xF);
	ioctl(uart_fd,HSUART_IOCTL_GET_UARTMODE,&uart_mode);
	uart_mode.speed = 0x384000; //115200
	uart_mode.flags = 0x9;
	ioctl(uart_fd, HSUART_IOCTL_SET_UARTMODE,&uart_mode);
	ioctl(uart_fd,HSUART_IOCTL_SET_RXLAT,0x80);

	//Wait for hello from chip
	read_fd(uart_fd);
//5386
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xda\xdc\xed\xed\xa9\x7a\xc0",12);
	read_fd(uart_fd);
//5406
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xda\xdc\xed\xed\xa9\x7a\xc0",12);
	read_fd(uart_fd);
//5430
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xad\xef\xac\xed\xa1\xa6\xc0",12);
	read_fd(uart_fd);
//5484
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xac\xaf\xef\xee\xbb\x84\xc0",12);
	read_fd(uart_fd);
//5504
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xde\xad\xd0\xd0\x83\x58\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);
	read_fd(uart_fd);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5681
	write_fd(uart_fd,"\xc0\x40\x41\x00\x7e\xad\xef\xac\xed\xa1\xa6\xc0",12);	
	read_fd(uart_fd);
	read_fd(uart_fd);
//5724
	write_fd(uart_fd,"\xc0\x48\x00\x00\xb7\x5e\x8c\xc0",8);
	usleep(75000);
	write_fd(uart_fd,"\xc0\xc8\x22\x01\x14\x00\x00\x09\x00\x00\x00\x59\x28\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x9a\xc0",26);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5820
	write_fd(uart_fd,"\xc0\x50\x00\x00\xaf\x53\xd1\xc0",8);
	usleep(2000);
	write_fd(uart_fd,"\xc0\xd1\x35\x00\xf9\x05\x10\x00\xdd\x97\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5850
	write_fd(uart_fd,"\xc0\xda\x35\x00\xf0\x03\x10\x00\xc1\x0d\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5865
	write_fd(uart_fd,"\xc0\x60\x00\x00\x9f\xdd\x6f\xc0",8);
	usleep(30000);
	write_fd(uart_fd,"\xc0\xe3\xa5\x00\x77\x33\x0c\x07\xfd\x03\x80\x64\x00\x10\x00\x49\x3d\xc0",18);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5925
	write_fd(uart_fd,"\xc0\x68\x00\x00\x97\xd4\xf9\xc0",8);
	usleep(30000);
	write_fd(uart_fd,"\xc0\xec\x35\x00\xde\x01\x10\x00\xb5\x55\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//5986
	write_fd(uart_fd,"\xc0\x70\x00\x00\x8f\xd9\xa4\xc0",8);
	usleep(100000);
	write_fd(uart_fd,"\xc0\xf5\x45\x00\xc5\x56\x0c\x01\x01\x71\x83\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6113
	write_fd(uart_fd,"\xc0\x78\x00\x00\x87\xd0\x32\xc0",8);
	usleep(30000);
	write_fd(uart_fd,"\xc0\xfe\x35\x00\xcc\x03\x10\x00\x0d\xe6\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6173
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(40000);
	write_fd(uart_fd,"\xc0\xc7\x55\x00\xe3\x18\x0c\x02\xdb\xdc\x5d\x77\xb4\xc0",14);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6278
	write_fd(uart_fd,"\xc0\x48\x00\x00\xb7\x5e\x8c\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xc8\x75\x00\xc2\x1c\x0c\x04\x00\x08\x12\x00\x09\xbe\xc0",15);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6380
	write_fd(uart_fd,"\xc0\x50\x00\x00\xaf\x53\xd1\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xd1\x45\x00\xe9\x43\x0c\x01\x00\x7e\x53\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6482
	write_fd(uart_fd,"\xc0\x58\x00\x00\xa7\x5a\x47\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xda\x45\x00\xe0\x45\x0c\x01\x02\x7f\x2a\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6584
	write_fd(uart_fd,"\xc0\x60\x00\x00\x9f\xdd\x6f\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xe3\xb5\x00\x67\x01\x0c\x08\xff\xff\xff\xff\xff\xff\xbf\x1d\x72\x41\xc0",19);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6686
	write_fd(uart_fd,"\xc0\x68\x00\x00\x97\xd4\xf9\xc0",8);
	usleep(15000);
	write_fd(uart_fd,"\xc0\xec\x55\x00\xbe\x0f\x08\x02\x0d\x00\x66\xdb\xdc\xc0",14);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6822
	write_fd(uart_fd,"\xc0\x70\x00\x00\x8f\xd9\xa4\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xf5\x45\x00\xc5\x47\x0c\x01\x00\xb8\xf0\xc0",12);
	read_fd(uart_fd);
	read_fd(uart_fd);
//6924
	write_fd(uart_fd,"\xc0\x78\x00\x00\x87\xd0\x32\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xfe\x35\x00\xcc\x14\x0c\x00\x88\x4a\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7051
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xc7\x45\x0f\xe4\x52\x0c\xf1\x01\x0a\x09\x43\x53\x52\x20\x2d\x20\x62\x63\x36\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\xd6\xc0",252);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7157
	write_fd(uart_fd,"\xc0\x48\x00\x00\xb7\x5e\x8c\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xc8\x75\x00\xc2\x1e\x0c\x04\x00\x10\x12\x00\x3e\x90\xc0",15);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7243
	write_fd(uart_fd,"\xc0\x50\x00\x00\xaf\x53\xd1\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xd1\x55\x00\xd9\x26\x0c\x02\x60\x00\xb2\xd0\xc0",13);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7345
	write_fd(uart_fd,"\xc0\x58\x00\x00\xa7\x5a\x47\xc0",8);
	usleep(10000);
	write_fd(uart_fd,"\xc0\xda\x65\x00\xdb\xdc\x24\x0c\x03\x04\x02\x00\x61\x9c\xc0",15);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7446
	write_fd(uart_fd,"\xc0\x60\x00\x00\x9f\xdd\x6f\xc0",8);
	usleep(25000);
	write_fd(uart_fd,"\xc0\xe3\x22\x01\xf9\x00\x00\x09\x00\x00\x00\x03\x70\x00\x00\xcc\x03\x01\x00\x00\x00\x00\x00\xdc\xad\xc0",26);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7613
	write_fd(uart_fd,"\xc0\x68\x00\x00\x97\xd4\xf9\xc0",8);
	usleep(35000);
	write_fd(uart_fd,"\xc0\xec\x35\x00\xde\x09\x10\x00\xf6\x36\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//7853
	write_fd(uart_fd,"\xc0\x70\x00\x00\x8f\xd9\xa4\xc0",8);
	usleep(100000);
	write_fd(uart_fd,"\xc0\xf5\x35\x00\xd5\x09\x10\x00\x51\x1a\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//8099
	write_fd(uart_fd,"\xc0\x78\x00\x00\x87\xd0\x32\xc0",8);
	usleep(35000);
	write_fd(uart_fd,"\xc0\xfe\x35\x00\xcc\x09\x10\x00\x53\x28\xc0",11);
	read_fd(uart_fd);
	read_fd(uart_fd);
//8269
	write_fd(uart_fd,"\xc0\x40\x00\x00\xbf\x57\x1a\xc0",8);
	usleep(200000);
	write_fd(uart_fd,"\xc0\xc7\x45\x0f\xe4\x52\x0c\xf1\x01\x03\x03\x00\x12\x0a\x09\x43\x53\x52\x20\x2d\x20\x62\x63\x36\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x85\xa8\xc0",252);

	for(i=0; i < 10; i++)	
		read_fd(uart_fd);

	printf("Version 4\n");

//Try to attach
	/* Set TTY to N_HCI line discipline */
	i = N_HCI;
	if (ioctl(uart_fd, TIOCSETD, &i) < 0) {
		perror("Can't set line discipline");
		return -1;
	}

	if (ioctl(uart_fd, HCIUARTSETPROTO, HCI_UART_BCSP) < 0) {
		perror("Can't set device");
		return -1;
	}


	p.fd = uart_fd;
	p.events = POLLERR | POLLHUP;

	sigfillset(&sigs);
	sigdelset(&sigs, SIGCHLD);
	sigdelset(&sigs, SIGPIPE);
	sigdelset(&sigs, SIGTERM);
	sigdelset(&sigs, SIGINT);
	sigdelset(&sigs, SIGHUP);

	while (1) {
		p.revents = 0;
		err = ppoll(&p, 1, NULL, &sigs);
		if (err < 0 && errno == EINTR)
			continue;
		if (err)
			break;
	}

//Wait 4 ever

	return 0;
}
